<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Astro Analysis Dashboard</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
        background-color: #0c0c0c;
        color: #d0f8ce;
      }
      .terminal {
        min-height: 100vh;
        padding: 2rem;
        background: radial-gradient(circle at top, #1b1b1b, #050505);
      }
      h1 {
        margin-top: 0;
        font-size: 1.5rem;
        color: #7df9ff;
      }
      .panes {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
      }
      .panel {
        flex: 1;
        min-width: 260px;
        background: rgba(8, 40, 50, 0.6);
        border: 1px solid #1f8a70;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 255, 214, 0.08);
      }
      label {
        display: block;
        margin-bottom: 0.25rem;
        color: #8ef9f3;
        font-weight: 600;
      }
      input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        border: 1px solid #1f8a70;
        background: rgba(0, 0, 0, 0.5);
        color: #d0f8ce;
      }
      button {
        padding: 0.5rem 1.25rem;
        border: 2px solid #1f8a70;
        background: transparent;
        color: #1f8a70;
        font-weight: 700;
        letter-spacing: 0.08em;
        cursor: pointer;
        border-radius: 5px;
      }
      button:hover {
        background: rgba(31, 138, 112, 0.2);
      }
      pre {
        white-space: pre-wrap;
        background: rgba(0, 0, 0, 0.35);
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #1f8a70;
        min-height: 8rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.95rem;
      }
      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.5rem;
        text-align: left;
      }
      th {
        color: #7df9ff;
      }
      .status-line {
        color: #9ef01a;
        margin-bottom: 0.25rem;
      }
      .hint {
        color: #ffd166;
        font-size: 0.85rem;
      }
      .pagination-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="terminal">
      <h1>&gt; astro-analysis-service :: dashboard</h1>
      <div class="panes">
        <section class="panel" id="controls">
          <h2>Filters</h2>
          <p class="hint">Lower magnitude = brighter object.</p>
          <label for="mag-min">Magnitude min (dimmer)</label>
          <input id="mag-min" type="number" step="0.01" placeholder="e.g. 0" />

          <label for="mag-max">Magnitude max (brighter)</label>
          <input id="mag-max" type="number" step="0.01" placeholder="e.g. 1" />

          <label for="dist-min">Distance min (ly)</label>
          <input id="dist-min" type="number" step="1" placeholder="e.g. 10" />

          <label for="dist-max">Distance max (ly)</label>
          <input id="dist-max" type="number" step="1" placeholder="e.g. 500" />

          <label for="constellation">Constellation</label>
          <input id="constellation" type="text" placeholder="e.g. Orion" />

          <label for="spectral">Spectral type</label>
          <input id="spectral" type="text" placeholder="e.g. G2" />

          <label for="search">Search term</label>
          <input id="search" type="text" placeholder="name or constellation" />

          <label for="page-size">Rows per page</label>
          <input id="page-size" type="number" min="1" max="100" value="25" />

          <button id="apply">APPLY FILTERS</button>
          <p class="status-line" id="status">Awaiting input...</p>
          <div class="pagination-controls">
            <button id="prev">PREV</button>
            <button id="next">NEXT</button>
          </div>
        </section>

        <section class="panel" id="stats-panel">
          <h2>Stats</h2>
          <pre id="stats">Loading stats...</pre>
        </section>
      </div>

      <section class="panel" style="margin-top: 1.5rem">
        <h2>Objects</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Constellation</th>
              <th>Magnitude</th>
              <th>Distance (ly)</th>
              <th>Spectral</th>
            </tr>
          </thead>
          <tbody id="objects-body">
            <tr><td colspan="5">Fetching catalog...</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <script>
      const statusLine = document.getElementById("status");
      const statsBlock = document.getElementById("stats");
      const tableBody = document.getElementById("objects-body");
      const applyBtn = document.getElementById("apply");

      async function fetchStats() {
        const response = await fetch("/stats");
        if (!response.ok) throw new Error("Failed to load stats");
        const data = await response.json();
        statsBlock.textContent = [
          `objects: ${data.count}`,
          `magnitude min: ${data.magnitude_min}`,
          `magnitude max: ${data.magnitude_max}`,
          `magnitude avg: ${Number(data.magnitude_avg).toFixed(3)}`,
          `brightest: ${data.brightest_object?.name ?? "n/a"}`,
          `dimmest: ${data.dimmest_object?.name ?? "n/a"}`,
        ].join("\n");
      }

      function buildQueryParams() {
        const minValue = document.getElementById("mag-min").value;
        const maxValue = document.getElementById("mag-max").value;
        const distMin = document.getElementById("dist-min").value;
        const distMax = document.getElementById("dist-max").value;
        const constellation = document.getElementById("constellation").value;
        const spectral = document.getElementById("spectral").value;
        const search = document.getElementById("search").value;
        const pageSize = document.getElementById("page-size").value || "25";
        const params = new URLSearchParams();
        if (minValue !== "") params.set("magnitude_min", minValue);
        if (maxValue !== "") params.set("magnitude_max", maxValue);
        if (distMin !== "") params.set("distance_min", distMin);
        if (distMax !== "") params.set("distance_max", distMax);
        if (constellation !== "") params.set("constellation", constellation);
        if (spectral !== "") params.set("spectral_type", spectral);
        if (search !== "") params.set("search", search);
        params.set("page", pagination.page);
        params.set("page_size", pageSize);
        return params.toString();
      }

      async function fetchObjects() {
        const query = buildQueryParams();
        const response = await fetch(`/objects${query ? `?${query}` : ""}`);
        if (!response.ok) throw new Error("Failed to load objects");
        const data = await response.json();
        renderRows(data.items);
        pagination.total = data.total;
        pagination.pages = data.pages;
        pagination.pageSize = data.page_size;
        pagination.page = data.page;
        updateStatus(data);
        updatePagerButtons();
      }

      function renderRows(items) {
        if (!items.length) {
          tableBody.innerHTML = `<tr><td colspan="5">No objects matched your filters.</td></tr>`;
          return;
        }
        tableBody.innerHTML = items
          .map(
            (obj) => `
            <tr>
              <td>${obj.name}</td>
              <td>${obj.constellation}</td>
              <td>${obj.magnitude}</td>
              <td>${obj.distance_ly}</td>
              <td>${obj.spectral_type}</td>
            </tr>`
          )
          .join("");
      }

      function updateStatus(payload) {
        const minValue = document.getElementById("mag-min").value || "—";
        const maxValue = document.getElementById("mag-max").value || "—";
        statusLine.textContent = `min ${minValue} / max ${maxValue} :: ${payload.total} objects :: page ${payload.page}/${payload.pages || 1}`;
      }

      function updatePagerButtons() {
        const prevBtn = document.getElementById("prev");
        const nextBtn = document.getElementById("next");
        prevBtn.disabled = pagination.page <= 1;
        const totalPages = Math.max(1, pagination.pages || 1);
        nextBtn.disabled = pagination.page >= totalPages;
      }

      async function refresh() {
        statusLine.textContent = "Fetching...";
        try {
          await Promise.all([fetchStats(), fetchObjects()]);
        } catch (error) {
          statsBlock.textContent = String(error);
          tableBody.innerHTML = `<tr><td colspan="5">${error}</td></tr>`;
          statusLine.textContent = "Something went wrong.";
        }
      }

      applyBtn.addEventListener("click", () => {
        pagination.page = 1;
        refresh();
      });

      document.getElementById("prev").addEventListener("click", () => {
        if (pagination.page > 1) {
          pagination.page -= 1;
          refresh();
        }
      });

      document.getElementById("next").addEventListener("click", () => {
        const totalPages = Math.max(1, pagination.pages || 1);
        if (pagination.page < totalPages) {
          pagination.page += 1;
          refresh();
        }
      });

      document.getElementById("page-size").addEventListener("change", () => {
        pagination.page = 1;
        refresh();
      });

      document.addEventListener("keydown", (event) => {
        if (event.key.toLowerCase() === "r" && (event.metaKey || event.ctrlKey)) {
          event.preventDefault();
          refresh();
        }
      });

      const pagination = { page: 1, pageSize: 25, pages: 0, total: 0 };
      refresh();
    </script>
  </body>
</html>
